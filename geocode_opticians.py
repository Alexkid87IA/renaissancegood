#!/usr/bin/env python3
"""
Script COMPLET pour extraire et g√©ocoder TOUS les opticiens Renaissance
240+ opticiens extraits des 14 pages du PDF
Usage: python3 extract_all_opticians.py
"""

import re
import json
import time
import requests
from typing import List, Dict

# TOUTES les donn√©es extraites du PDF - 240+ opticiens (14 pages compl√®tes)
OPTICIANS_RAW_DATA = """
100012|VOGUE DIFFUSION OPTIQUE|52 ROUTE DE BORNY CS 45077|57072|METZ CEDEX 03
100025|LA VUE PLUS BELLE|49 RUE DU VINGT-DEUX NOVEMBRE|67000|STRASBOURG
100026|MONSIEUR OPTIQUE SASU|79 AVENUE DE THIONVILLE|57050|METZ
100029|SARL PBG OPTIC|CHEZ OLBA|57211|SARREGUEMINES CEDEX
100043|OPTIQUE SAINT OUEN|120 AVENUE GABRIEL PERI|93400|SAINT OUEN
100064|OPTICLAIR|74 BOULEVARD ORNANO|75018|PARIS
100100|L'ATELIER DE L'OPTIQUE|3 BOUCLE DU VAL MARIE|57100|THIONVILLE
100104|LA MAISON DU LUNETIER|30 BOULEVARD DE CHARONNE|75020|PARIS
100106|OPTICLAIR / SARL LGA CLICHY|126 AVENUE DE CLICHY|75017|PARIS
100114|CHATEAU D'OPTIQUE|37 RUE DU CHATEAU D EAU|75010|PARIS
100119|LES OPTICIENS KRYS|16 RUE HIRSCHAUER|57500|SAINT AVOLD
100164|AFFLELOU|33 RUE BANAUDON|54300|LUNEVILLE
100167|OPTICAL DISTRICT|13 PLACE DU CAQUET|93200|SAINT DENIS
100169|VISION D AVENIR CENTRE OPTIQ|179 RUE SAINT MAUR|75010|PARIS
100196|SARAH VISION|3 A RUE DU GENERAL PATTON|57330|HETTANGE-GRANDE
100215|VOGUE DIFFUSION OPTIQUE|52 ROUTE DE BORNY CS 45077|57072|METZ CEDEX 03
100231|HOUSE OPTIC|168 BIS AVENUE PIERRE SEMARD|95400|VILLIERS LE BEL
100249|GREZ OPTIC|6 PLACE GALILEE|21000|DIJON
100251|VOGUE OPTIQUE DIFFUSION|52 ROUTE DE BORNY CS45077|57072|METZ CEDEX 03
100253|OPTICAL|23 RUE DU POTEAU|75018|PARIS
100257|STRAS OPTIC 2|8 BLD LEBLOIS|67000|STRASBOURG
100258|OPTOCENTER|12 RUE DU FAUBOURG DE SAVERNE|67000|STRASBOURG
100270|JMV OPTIC SAS|57 RUE PIERRE CHARRON|75008|PARIS
100273|UNIVERS OPTIQUE|54 OP ZAEMER|4959|BASCHARAGE
100284|GRIFFOPTICAL|80 GRAND RUE|57280|MAIZIERES LES METZ
100285|EYES CAMSI|93 AVENUE GABRIEL PERI|92600|ASNIERES SUR SEINE
100289|OPTIQUE HEXAGONE|4 RUE DU DR JEAN MARC BECKER|25200|MONTBELIARD
100295|OPTICIEN D'EXCEPTION|3 BOULEVARD DE LA DORDOGNE|67000|STRASBOURG
100307|OPTIK|29 ROUTE D'INGERSHEIM|68000|COLMAR
100326|VOGUE DIFFUSION OPTIQUE|52 ROUTE DE BORNY CS 45077|57072|METZ CEDEX 03
100339|VOGUE DIFFUSION OPTIQUE|52 ROUTE DE BORNY CS 45077|57072|METZ CEDEX 03
100340|VOGUE DIFFUSION OPTIQUE|52 ROUTE DE BORNY CS 45077|57072|METZ CEDEX 03
100347|LUN OPTIC / SAS PHOM|ZAC PLATEAU DE HAYE|54100|NANCY
100349|ORIGINAL OPTIC|9 RUE FRANCHE COMTE|67100|STRASBOURG
100355|BSD OPTIC|21 BOULEVARD BARBES|75018|PARIS
100369|LA LUNETTE MODERNE|45 BOULEVARD RICHARD LENOIR|75011|PARIS
100375|ART DE LA VUE|28 BIS RUE J.-J.ROUSSEAU|93190|LIVRY GARGAN
100377|PANAM'OPTIC|31 BOULEVARD DE BONNE NOUVELLE|75002|PARIS
100378|LE MONDE DE L'OPTIQUE|4 RUE DE STOCKHOLM|90000|BELFORT
100394|HISTOIRE D'OPTIC|32 RUE DE LA CHAPELLE|75018|PARIS
100419|AVENIR OPTIC|2 PLACE STE MARTHE|57350|STIRING WENDEL
100436|PROPTIQUE|20 RUE ARISTIDE BRIAND|78130|LES MUREAUX
100438|PANTIN OPTIQUE|SAS LIAD|93500|PANTIN
100449|OPTICAL BLINK|5 PLACE DU 25 AOUT 1944|75014|PARIS
100452|CELINE OPTICIEN LUNETIER|6 RUE DU STADE|68400|RIEDISHEIM
100455|ATOL MON OPTICIEN|ROUTE DES PETITS PONTS|93270|SEVRAN
100469|JBAZ OPTIQUE|ART DE VOIR|75009|PARIS
100470|OPTIC 2000|1 RUE DU DR MICHEL|52000|CHAUMONT
100471|OPTICA STORE|3 RUE LANGEVIN|67200|STRASBOURG
100480|OPTIC CADET|26 RUE CADET|75009|PARIS
100481|AROPTIC|81 BLD PASTEUR|93120|LA COURNEUVE
100483|PHARMACIE ARC EN CIEL|C CIAL ARC EN CIEL|95140|GARGES LES GONESSE
100496|LUXE OPTIC|157 ROUTE DE VIENNE|69008|LYON
100503|OS+ OPTICAL SERVICE|76 RUE DE PROVENCE|75009|PARIS
100504|OPTIC ALAIN|92 AV DU GENERAL DE GAULLE|94000|CRETEIL
100506|FRANK'OPTIC|177 BD DE LA BOISSIERE|93100|MONTREUIL
100531|CRYSTAL VISUAL|9 RUE ALBERT 1ER|94600|CHOISY LE ROI
100533|OPTIQUE SEBASTOPOL|16 AVENUE SEBASTOPOL|57070|METZ
100535|OPTIQUE LAFAYETTE|SARL BFM|68200|MULHOUSE
100554|OPTIQUE DU CENTRE|133 RUE JEAN JAURES|94700|MAISON ALFORT
100564|UNE AUTRE VISION|6/8 AV DU GENERAL DE GAULLE|93410|VAUJOURS
100587|OPTIQUE DE L'HORLOGE|18 RUE DE L'ABONDANCE|95800|CERGY ST CHRISTOPHE
100588|OPTIQUE DE L'HORLOGE|71 AVENUE DES GRESILLONS|92230|GENNEVILLIERS
100601|LA MAISON DU LUNETIER|24 RUE DE LA GOUTTE D OR|75018|PARIS
100605|HOUSE OPTIC|88 AVENUE HENRI BARBUSSE|93700|DRANCY
100606|LA VISION BY W.M. VISION AMA|9 AVENUE D'ESTREES|97300|CAYENNE
100610|OPTIK POUR TOUS|78-80 AVENUE DE LA DIVISION|93350|LE BOURGET
100614|MONTAIGNE OPTIQUE/LAURE OPT.|SARL LAURE OPTIQUE|75008|PARIS
100616|DJENAYA OPTIQUE|48 RUE HENRI BARBUSSE|93370|MONTFERMEIL
100622|ON VIEW|AVENUE EDMOND CANDRIES 39|1080|BRUXELLES
100630|AULNOY OPTIC|21 BOULEVARD PIERRE MENDES|77500|CHELLES
100633|A & F OPTIC|4 RUE AUGUSTE DELAGE|69680|CHASSIEU
100635|OPTIC XIV|76 RUE D'ALESIA|75014|PARIS
100639|VISTAVUE SARL|CHEMIN DU VIADUC 1|1008|PRILLY
100640|LA PERLE D OPTIQUE|64 RUE CURIAL|75019|PARIS
100642|L'OPTICIEN|CLEAR OPTIC|75019|PARIS
100650|LES LUNETTES DE SAMI GHANEM|242 RUE DE CRIMEE|75019|PARIS
100652|NEW OPTIC|BENCH OPTIC|95130|FRANCONVILLE
100656|OZ OPTIQUE|102 BIS RUE DU GENERAL LECLERC|95410|GROSLAY
100658|VENY OPTIQUE|3 RUE MICHEL GERMANEAU|69200|VENISSIEUX
100659|AIR OPTIQUE|16 AVENUE PAUL VAILLANT|94400|VITRY SUR SEINE
100673|L'OEIL DE LEO|30 RUE ANATOL FRANCE|42300|ROANNE
100678|ELLA OPTIC|8 RUE GEORGES SEURAT|93600|AULNAY SOUS BOIS
100692|INTEROPTICAL RUDDY OPTIC|C CIAL INTERMARCHE|91130|RIS ORANGIS
100695|SAINT BRICE OPTIQUE|47 RUE DE PARIS|95350|SAINT BRICE SOUS FORET
100702|MON OPTICIEN|ZEBRE OPTIC|06140|VENCE
100716|CONCEPT OPTIQUE|5 COURS TOLSTOI|69100|VILLEURBANNE
100735|MES BELLES LUNETTES|57 BOULEVARD FOCH|93800|EPINAY SUR SEINE
100737|OPTIC AUDIO CRESSON|33 AVENUE VICTOR CRESSON|92130|ISSY LES MOULINEAUX
100750|EFFET D'OPTIC / ELYE SAS|3 PLACE DE L'EGLISE|93600|AULNAY SOUS BOIS
100758|MA VISION|CC CARREFOUR|30000|NIMES
100764|TERRE D'OPTIQUE|36 RUE LENINE|94200|IVRY SUR SEINE
100766|OTIKA INSTRUMENT|YOUSSEF AKKA|39400|MOREZ
100769|AKYDI OPTICAL SARL|CH.DU LYNX 5|1273|ARZIER LE MUIDS
100779|JJ DISTRIBUTION|48 RUE JEAN FIOLLE|13006|MARSEILLE
100790|SOS OPTIQUE|1 BIS PLACE MARC SANGNIER|69008|LYON
100799|LISSAC|225A AVENUE SAINT EXYPERY|06210|MANDELIEU LA NAPOULE
100823|FAUBOURG OPTICAL|88 RUE DU FAUBOURG ST MARTIN|75010|PARIS
100825|OPTIQUE VISION|115 AVENUE DE SAINT LOUIS|13015|MARSEILLE
100830|J&J OPTICAL|OPTIC PLAZZA|13480|CABRIES
100831|L OPTICIEN|21 EN FOURNIRUE|57000|METZ
100838|BDEB EYEWEAR|16 RUE OLIVIER MESSIAEN|75013|PARIS
100840|OPTICAL DISCOUNT|71 AVENUE DE LA VISTOIRE|77100|MEAUX
100844|MICKYAEL OPTIK|35 RUE DU GENERAL DE GAULLE|95880|ENGHIEN LES BAINS
100854|CREATIV'OPTIQUE|29 RUE DE LA LIBERTE|57520|GROSBLIEDERSTROFF
100860|RETINEYES|20 AVENUE LOUIS LARIVIERE|93440|DUGNY
100866|OPTIC DE LA PORTE D'AIX|2 RUE BERNARD DU BOIS|13001|MARSEILLE
100884|DJ RAZE|RAZES BRILLEN BOUTIQUE|75173|PFORZHEIM
100886|AZDAY OPTIC|STE REMAZCO|75010|PARIS
100890|OPTIC A L'OEIL|51 RUE FREBAULT|97110|POINTE A PITRE
100896|DPD|RUE MARC SEGUIN|57365|ENNERY
100897|OPTICAL BRIAND|102 AVENUE ARISTIDE BRIAND|92120|MONTROUGE
100898|AUTRE VUE|STE. SJA OPTIC|75019|PARIS
100900|STYLE OPTIQUE|6395 PAPINEAU H2G2X1|MONTREAL-QUEBEC
100905|OPTIQUE PRO|STE. MANELLE|93370|MONTFERMEIL
100906|LM OPTIC DESIGN|114 AVENUE JEAN JAURES|75019|PARIS
100917|Y VOIR CLAIR|3 RUE DE COLMAR|78200|MANTES LA JOLIE
100923|OPTICAL DISTRIKT/STE RABEL O|4 BOULEVARD GALLIENI|92390|VILLENEUVE LA GARENNE
100925|MON OPTICIEN|531 AVENUE PAUL JULIEN|13100|LE THOLONET
100933|SO OPTIC|SAS MAR.WAN|59100|ROUBAIX
100935|ZAFF OPTICAL|11 RUE DU POT D'OR|4000|LIEGE
100937|URBAN OPTIC|150 RUE EDOUARD VAILLANT|95870|BEZONS
100943|OPTIQUE MEDAR|1 PLACE DU CAPITOLE|31000|TOULOUSE
100959|SEESEE|10 RUE DE PENTHIEVRE|75008|PARIS
100973|OPTIQUE UNTERLINDEN|GALERIE DU REMPART|68000|COLMAR
100975|HAPPY OPTIC|9 RUE COLBERT|13001|MARSEILLE
100989|OPTIQUE DE LA GARE SANNOIS|4 PLACE SALVADOR ALLENDE|95110|SANNOIS
100992|OPTIC PARIS|27 RUE ETIENNE DOLET|94140|ALFORTVILLE
101013|VISION-ERE / EYEWEARCAFE|CH-IL srl|1000|BRUXELLES
101024|OPTIQUE MOLIERE|19 AVENUE NELSON MANDELA|93240|STAINS
101025|OPTIC DNS|41 RUE NATIONALE|72000|LE MANS
101026|OPTIQUE BEAUVAL|ALLEE JEAN LOUIS BARRAULT|77100|MEAUX
101039|LUXURY FASHION VISION|120/122 RUE DE LAGNY|93100|MONTREUIL
101046|BRIGHT 10 OPTIQUE|61 BOULEVARD BARBES|75018|PARIS
101047|VISION-ERE OPTIQUE|STE. RB OPTIC|78180|MONTIGNY LE BRETONNEUX
101054|LES OPTICIENS DE BOBIGNY|OPTICAL SANTE SARL|93000|BOBIGNY
101063|L'ATELIER DE LA LUNETTE|19 RUE JEAN WEBER|31100|TOULOUSE
101064|OPTIC CONCEPT|56 RUE DES LAITIERES|94300|VINCENNES
101066|PLAISIR DE VOIR / CANNES|OPTICIEN DE FRANCE|77400|ST THIBAULT DES VIGNES
101067|FRENCH OPTICAL|C/COMMERCIAL LES 3 FONTAINES|95000|CERGY
101070|NAYEL OPTIC|34 BOULEVARD DE MAGENTA|75010|PARIS
101071|PALACE OPTIQUE|114 AVENUE HENRI BARBUSSE|93700|DRANCY
101083|ATOL CERGY 3 FONTAINES|13-16 RUE DES GALERIES|95000|CERGY
101089|MON OPTICIEN / SC OPTIC|MOF06025|06200|NICE
101090|COTY OPTIQUE|32 RUE ANDRE CAPLET|76600|LE HAVRE
101098|LUNETTERIE D'EXCEPTION|82 AVENUE DANIELLE CASANOVA|94200|IVRY SUR SEINE
101106|HORS PAIR|STE. CJT CONCEPT|75017|PARIS
101117|LE LUNETIER|SAS SNK OPTIC|57600|FORBACH
101122|OPTICAL DISTRIKT/STE BNB OPT|50 AVENUE DU MARECHAL FOCH|95100|ARGENTEUIL
101125|BO OPTIC|FAR OPTIC EURL|57200|SARREGUEMINES
101128|AU COMPTOIR DE L'IRIS|41 BOULEVARD DU GENERAL|59100|ROUBAIX
101131|CERCLE OPTICAL|121-123 AVENUE DU GENERAL|94500|CHAMPIGNY SUR MARNE
101145|OZ OPTIC / SAS OZ|13 RUE DU MARECHAL DE LATTRE|95190|GOUSSAINVILLE
101146|SENSORIEL|1 RUE COLONEL MOLL|93600|AULNAY SOUS BOIS
101148|OPTICAL STUDIO|STE. KIMEL|75001|PARIS
101154|L'OPTICIEN LISSAC|B'EST OPTIC EURL|57200|SARREGUEMINES
101166|NOOR OPTIQUE|50 AVENUE DE COLMAR|68100|MULHOUSE
101177|LA MAISON DU LUNETIER|CENTRALE D'ACHAT|75020|PARIS
101178|CARRERA GUILLAUME|11 RUE COQUETTES|94800|VILLEJUIF
101182|CELINE ROLAND LUNETIER|SAS OCV|68100|MULHOUSE
101184|CLIN D'OEIL OPTICIEN|2 RUE DES CLEFS|68000|COLMAR
101186|J&J OPTICAL|26 RUE SAINT FERREOL|13001|MARSEILLE
101201|WALTER S OPTICIENS|88 RUE DE LONGCHAMPS|75116|PARIS
101203|JP OPTICS|PARASKEVAIDIS LOANNIS|16675|GLYFADA ATHENS
101204|M.C COMPANY|22 RUE HENRY DUHAMEL|38100|GRENOBLE
101214|PRESTIGE VISION ET AUDITION|3 RUE BLONDEL|75003|PARIS
101215|PANAM OPTIC|STE CBR VISION|75008|PARIS
101216|LES LUNETTES DE FRANCK|210 AVENUE JEAN JAURES|69150|DECINES
101244|SHOPTALUNETTE|7 RUE GUIZOT|30000|NIMES
101262|OPTIMA OPTIC|8A PLACE DU COMTE DE BENDERN|78170|LA CELLE SAINT CLOUD
101265|AUDIOPTIKA|25 RUE PAUL VAILLANT COUTURIER|95100|ARGENTEUIL
101275|L'OPTICIEN CONCEPT|16 RUE SIMONE VEIL|95870|BEZONS
101279|LBM OPTIC|9 AVENUE PIERRE ET MARIE CURIE|93150|LE BLANC MESNIL
101296|PANAM OPTIC|13 RUE TURBIGO|75002|PARIS
101298|OPTIQUE LYS|4 RUE DU VIEUX MOULIN|25310|HERIMONCOURT
101300|MAISON OZKAN|61 RUE JEAN LIGONNET|69700|GIVORS
101304|LUNE OPTIQUE|110 AVENUE PAUL VAILLANT|94400|VITRY SUR SEINE
101315|PRIME OPTIQUE|129 BOULEVARD JEAN MERMOZ|93380|PIERREFITTE SUR SEINE
101317|EYE OPTICAL|SARL LA CENTRALE D'OPTIQUE|95360|MONTMAGNY
101323|BINOCL'ART|CHAUSSEE DE WATERLOO 974|1180|UCCLE
101326|DEESSE OPTICAL/POINT OPTICAL|50 RUE DES LYS|91150|ETAMPES
101329|VU ENTENDU|101-103 AVENUE DE L'EUROPE|60180|NOGENT SUR OISE
101344|AU BON OEIL|2 BOULEVARD ICARD ET FRANCOIS|13010|MARSEILLE
101348|VIVALDI OPTIQUE|MOUKY OPTIQUE|75012|PARIS
101358|ESEA OPTIQUE ET AUDITION|OPTICIEN CONCEPT ET AUDITION|93800|EPINAY SUR SEINE
101368|EYE VIEW|101 AVENUE DU GENERAL DE|74200|THONON LES BAINS
101376|LA MAISON DU LUNETIER|30 AVENUE DUMONT|93600|AULNAY SOUS BOIS
101377|CARTIER OPTIQUE|CENTRE COMMERCIAL AUCHAN|83580|GASSIN
101378|POTHIN RICHIE|1683 CHEMIN LAGOURGUE|97440|SAINT ANDRE
101389|VIEWS BASTILLE|STE DAV AND JOYCE OPTIC|75011|PARIS
101395|HMD OPTIQUE|LES LUNETTES DE FONSALA|42400|SAINT CHAMOND
101405|OPTIQUE ET AUDITION|37 BOULEVARD JEAN JAURES|92110|CLICHY
101407|CHOUF|STE MSN OPTIC|75018|PARIS
101412|WESNEL OPTIQUE|39 AVENUE GAMBETTA|75020|PARIS
101414|IB OPTIQUE ATELIER OPTIC|17 AVENUE VLADIMIR ILITCH|92000|NANTERRE
101425|FRANKOPTIC ET AUDITION|50 RUE VICTOR HUGO|92300|LEVALLOIS PERRET
101440|MIDON VISION GMBH|HUMBOLDSTRASSE 15|14193|BERLIN
101447|AURES OPTIC|35 BOULEVARD BERNABO|13015|MARSEILLE
101458|OPTIQUE DU 69 / AYZO|6 COURS LAFAYETTE|69003|LYON
101464|HOUSE OF SHADES|MANCHESTER TOWER 10|1003|DUBAI MARINA
101482|OPTIQUE LORETTE|63 BOULEVARD BEDIER|49000|ANGERS
101486|OPTIC D'OR|9 RUE ERIC DE SAINT SAUVEUR|95200|SARCELLES
101497|OPTIK BUDGET|67 BOULEVARD LAFAYETTE|63000|CLERMONT FERRAND
101522|LISSAC|76 BOULEVARD DE STRASBOURG|83000|TOULON
101526|J&J OPTICAL|SAS BENJI OPTIC|13011|MARSEILLE
101534|OOPTICIEN|20 RUE PORTE AUX SAINTS|78200|MANTES LA JOLIE
101552|JOSEPH OPTICIENS|48 BOULEVARD RABATAU|13008|MARSEILLE
101559|OPTIQUE MZ|18 PLACE DU MARCHE AU BLE|77130|MONTEREAU
101561|H&B OPTICIEN LUNETIER|3 RUE YAN AUDOUARD|13200|ARLES
101576|F&I OPTIQUE|22 RUE MABLY|33000|BORDEAUX
101591|ARIA OPTIC|21 RUE DESIRE DELANSORNE|62000|ARRAS
101614|GOLD'EYES SAS|75 RUE SOMMEVILLE|77380|COMBS LA VILLE
101618|MISTER LUNETTES DIDEROT|114 BOULEVARD DIDEROT|75012|PARIS
101626|HYPE OPTIQUE|45 BOULEVARD RICHARD LENOIR|75011|PARIS
101644|ADNOOPTIQUE|116 RUE HELENE COCHONNEC|93300|AUBERVILLIERS
101655|LA LUNETTE NOIRE|STE LMT OPTIC|75020|PARIS
101664|MAISON LUNETTERIE|SAS YKL OPTIC|78200|MANTES LA JOLIE
101665|LYNX OPTIQUE|SARL MEDIA OPTIQUE|97232|LE LAMENTIN
101666|LA LUNETTERIE|SARL SHIVA OPTIQUE|97231|LE ROBERT
101667|LA LUNETTERIE DU FRANCOIS|SARL ANACROUSE|97240|LE FRANCOIS
101669|LA LUNETTERIE / SARL VYF|IMMEUBLE DIGITAL|97232|LE LAMENTIN
101671|OPTIC 2000 / SAS AREL OPTIC|CENTRE COMMERCIAL BEAU SEVRAN|93270|SEVRAN
101673|LES OPTICIENNES|SARL OPTIQUE BELLE VUE|97200|FORT DE FRANCE
101675|HORS PAIRES|MAIL DE THORIGNY|91490|MILLY LA FORET
101676|LA LUNETTERIE / SARL MAC4|ZAC ARTIMER|97290|LE MARIN
101680|LA LUNETTERIE / SARL BCAT|ZAC LA LAUGIER|97215|RIVIERE SALEE
101688|POINT DE VUE SANTE|26 AVENUE GABRIEL PERI|95870|BEZONS
101695|MAISON DE L'AUDIO-OPTIQUE|107 BOULEVARD CHARLES DE|92700|COLOMBES
101707|OPTIC LEGROS DESTRELAND|CENTRE COMMERCIAL DESTRELAND|97112|BAIE MAHAULT
101710|KANN'OPTIK|ZAC DOTHEMARE NORD|97139|LES ABYMES
101712|OPTIC LEGROS|RUE DE L'EGLISE|97110|POINTE A PITRE
101714|PERSEPOLIS OPTICAL|ZI JARRY IMMEUBLE TIENGOU|97122|BAIE MAHAULT
101720|OPTIC LEGROS|14 RUE DU DR CABRE|97100|BASSE TERRE
101724|LUX4SEE/ PERSEPOLIS|ZAE DE CALBASSIER|97100|BASSE TERRE
101740|MORPHOPTIQUES|57 AVENUE CHRISTOPHE COLOMB|97320|SAINT LAURENT DU MARON
101747|ATOL / SARL OPTIC PAUL|60 RUE SAINT STENAY|93700|DRANCY
101749|DOM'OPTIK|SASU DOM'OPTIK|95290|L'ISLE ADAM
101781|OPTICADOM|STE OPTICADOM|92700|COLOMBES
101821|IRENA MYRTA|BULEVARDI BAJRAM CURRI 156|1001|TIRANA
101833|OPTIKA M|6 BIS QUAI SADI CARNOT|77100|MEAUX
101836|JUVINA OPTIC|43 RUE BOISSY D'ANGLAS|75008|PARIS
101837|HISTOIRE D'OPTIC|EHI VISION|75019|PARIS
101856|L'ATELIER DU REGARD|16 RUE RASTEGUE|13400|AUBAGNE
101867|LA FABRIQUE DE L'OPTIQUE|AR OPTIC|95330|DOMONT
101890|BLF OPTIQUE ET AUDITION|102 RUE DE BAGNOLET|75020|PARIS
101899|OPTIQUE K/ OPTIC MANS|346 AVENUE DE BIR HAKEIM|30000|NIMES
101903|OPTIK & POINT CARE|OPTIQUE POINT CARE|95200|SARCELLES
101927|IM OPTICAL|130 AVENUE DE LA VISTE|13015|MARSEILLE
101929|LUMIN'EYES SASU MS OPTIQ|177 RUE PAUL VAILLANT|94140|ALFORTVILLE
101933|VISION STORE / BD OPTIC|4 PLACE DE LA LIBERATION|77600|BUSSY SAINT GEORGES
101934|MAISON RIBIER|50 AVENUE ALFRED BORRIGLIONE|06100|NICE
101972|OPTI'K INO|35 BD GAMBETTA|78300|POISSY
101981|VU & ENTENDU/L'OPTIQUE DU PO|246 AVENUE PIERRE BROSSOLETTE|94170|LE PERREUX SUR MARNE
101985|CENTRE OPTIQUE & AUDITION|SAS TREMBLAY OPTIQUE&AUDITION|93290|TREMBLAY EN FRANCE
101991|IN OPTIC|60 RUE DE LA REPUBLIQUE|13002|MARSEILLE
102001|LA PALETTE DES OPTICIENS|C/C DOMAINE DE L'ESCAPADE|13100|LE THOLONET
102005|J&J OPTICAL|SAS JF OPTIQUE|84200|CARPENTRAS
102008|J&J OPTICAL LA ROSE|11 AVENUE FRANCOIS MIGNET|13013|MARSEILLE
102009|ATOL|6 RUE DE LA MARNE|51000|CHALONS EN CHAMPAGNE
102010|L'OPTICIEN DU MARAIS|FRAME HLM|75004|PARIS
102017|J&J OPTICAL|33 CHEMIN DU PUIT DE BRUNET|13600|LA CIOTAT
102021|J&J OPTICAL LA VALENTINE|2 TRAVERSE DES FABRES|13011|MARSEILLE
102022|AZ AUDIOPTIC|270 RUE PIERRE MENDES|78370|PLAISIR
102026|CENTRE OPTIQUE|71 RUE DE GRAVIGNY|91380|CHILLY MAZARIN
102027|THOMAS LUNETIER|8 PLACE DU MARCHE|91310|MONTLHERY
102038|OPTIQUE +|20 AVENUE VICTOR HUGO|93320|PAVILLONS SOUS BOIS
102068|CARL OPTIQUE|3 AVENUE RAYMOND POINCARE|68000|COLMAR
""".strip()


def clean_address(address: str, postal_code: str, city: str) -> str:
    """Nettoie et formate une adresse pour le g√©ocodage"""
    # Supprimer les mentions CS, CEDEX, etc.
    address = re.sub(r'\s*CS\s+\d+', '', address)
    address = re.sub(r'\s*CEDEX\s+\d*', '', address)
    city = re.sub(r'\s*CEDEX\s+\d*', '', city)
    
    # G√©rer les adresses incompl√®tes
    if address.startswith('SAS ') or address.startswith('SARL ') or address.startswith('STE'):
        # Si l'adresse est juste un nom de soci√©t√©, essayer avec juste la ville
        return f"{city}, France"
    
    return f"{address}, {postal_code} {city}, France"


def geocode_address(address: str, retry_count: int = 0) -> Dict:
    """
    G√©ocode une adresse en utilisant l'API Nominatim (OpenStreetMap - gratuite)
    """
    base_url = "https://nominatim.openstreetmap.org/search"
    
    params = {
        'q': address,
        'format': 'json',
        'limit': 1,
        'countrycodes': 'fr,be,lu,ch,mc,gr'  # France + pays limitrophes + Gr√®ce (Athens)
    }
    
    headers = {
        'User-Agent': 'Renaissance-Eyewear-Store-Locator/1.0 (contact@renaissance-eyewear.fr)'
    }
    
    try:
        response = requests.get(base_url, params=params, headers=headers, timeout=10)
        response.raise_for_status()
        data = response.json()
        
        if data and len(data) > 0:
            return {
                'latitude': float(data[0]['lat']),
                'longitude': float(data[0]['lon']),
                'display_name': data[0].get('display_name', ''),
                'found': True
            }
        else:
            return {'found': False}
            
    except Exception as e:
        if retry_count < 2:  # Retry up to 2 times
            time.sleep(2)
            return geocode_address(address, retry_count + 1)
        return {'found': False, 'error': str(e)}


def parse_and_geocode_all() -> List[Dict]:
    """Parse et g√©ocode tous les opticiens"""
    opticians = []
    lines = OPTICIANS_RAW_DATA.split('\n')
    
    total_lines = len([l for l in lines if l.strip()])
    print(f"üöÄ D√©marrage du g√©ocodage de {total_lines} opticiens...\n")
    print(f"‚è±Ô∏è  Temps estim√©: ~{int(total_lines * 1.2 / 60)} minutes (limite API gratuite)\n")
    
    counter = 0
    for line in lines:
        if not line.strip():
            continue
        
        counter += 1
        parts = line.split('|')
        if len(parts) < 4:
            continue
        
        id_client = parts[0].strip()
        name = parts[1].strip()
        address = parts[2].strip()
        postal_code = parts[3].strip()
        city = parts[4].strip() if len(parts) > 4 else postal_code
        
        # Nettoyer et formater l'adresse
        full_address = clean_address(address, postal_code, city)
        
        print(f"[{counter}/{total_lines}] {name} - {city}")
        
        # G√©ocoder
        geo_result = geocode_address(full_address)
        
        optician = {
            'id': id_client,
            'name': name,
            'address': address,
            'postalCode': postal_code,
            'city': city,
            'fullAddress': full_address
        }
        
        if geo_result.get('found'):
            optician['latitude'] = geo_result['latitude']
            optician['longitude'] = geo_result['longitude']
            print(f"   ‚úÖ Trouv√©: {geo_result['latitude']:.4f}, {geo_result['longitude']:.4f}")
        else:
            # Coordonn√©es par d√©faut (Paris) si g√©ocodage √©choue
            optician['latitude'] = 48.8566
            optician['longitude'] = 2.3522
            print(f"   ‚ö†Ô∏è  Non trouv√© - Coordonn√©es Paris par d√©faut")
        
        opticians.append(optician)
        
        # Pause de 1.2 secondes entre chaque requ√™te (respecter les limites de l'API)
        time.sleep(1.2)
    
    return opticians


def save_to_json(opticians: List[Dict], filename: str = 'opticians.json'):
    """Sauvegarde les opticiens en JSON"""
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(opticians, f, ensure_ascii=False, indent=2)
    
    print(f"\n‚úÖ Fichier {filename} cr√©√© avec succ√®s!")
    print(f"üìä {len(opticians)} opticiens g√©ocod√©s")
    
    # Statistiques
    geocoded_count = sum(1 for o in opticians if o['latitude'] != 48.8566 or o['longitude'] != 2.3522)
    print(f"‚ú® {geocoded_count} g√©ocodages r√©ussis ({geocoded_count/len(opticians)*100:.1f}%)")


if __name__ == "__main__":
    print("=" * 60)
    print("üó∫Ô∏è  RENAISSANCE EYEWEAR - STORE LOCATOR")
    print("    Extraction et G√©ocodage COMPLET des Opticiens")
    print("=" * 60)
    print()
    
    try:
        geocoded_opticians = parse_and_geocode_all()
        save_to_json(geocoded_opticians)
        
        print("\n" + "=" * 60)
        print("‚ú® TERMIN√â ! Le fichier opticians.json est pr√™t.")
        print("=" * 60)
        print("\nüìÅ Place ce fichier dans: src/data/opticians.json")
        print("üöÄ Et lance ton site avec: npm run dev")
        
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Op√©ration annul√©e par l'utilisateur")
    except Exception as e:
        print(f"\n\n‚ùå Erreur: {e}")